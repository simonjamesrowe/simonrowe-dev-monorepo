# Data Model: Profile Chat with MCP Tools

**Feature**: 009-profile-chat
**Date**: 2026-02-26

## Overview

This feature introduces **no new database collections**. All chat data is ephemeral and held in-memory. The data model describes the in-memory structures and message contracts used for WebSocket communication and MCP tool I/O.

## Entities

### ChatSession (In-Memory Only)

An ephemeral conversation held in `InMemoryChatMemoryRepository` (Spring AI).

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| sessionId | UUID (string) | Unique conversation identifier | Generated by frontend, used as `ChatMemory.CONVERSATION_ID` |
| messages | List\<Message\> | Ordered list of conversation messages | Managed by `MessageWindowChatMemory` (max 20 messages) |
| lastActivity | Instant | Timestamp of last message sent/received | Used for stale session eviction (30 min TTL) |

**Notes**:
- Not a MongoDB document — exists only in JVM heap
- `InMemoryChatMemoryRepository` handles message storage internally
- `lastActivity` tracked separately in a `ConcurrentHashMap<String, Instant>`

---

### ChatRequest (WebSocket Inbound Message)

Message sent from the frontend to the backend via STOMP.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| sessionId | String | UUID identifying the chat session | Required, UUID format |
| message | String | User's message text | Required, 1–500 characters |

---

### ChatResponse (WebSocket Outbound Message)

Message sent from the backend to the frontend via STOMP.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| sessionId | String | UUID identifying the chat session | Always present |
| content | String | Response text (full or partial for streaming) | May be empty during stream start |
| type | String | Message type: `STREAM_START`, `STREAM_CHUNK`, `STREAM_END`, `ERROR` | Required |
| timestamp | String | ISO-8601 timestamp | Always present |

**Message flow**:
1. Client sends `ChatRequest` → `/app/chat.send`
2. Server sends `ChatResponse(type=STREAM_START)` → `/topic/chat.{sessionId}`
3. Server sends multiple `ChatResponse(type=STREAM_CHUNK)` with partial content
4. Server sends `ChatResponse(type=STREAM_END)` with complete content

---

### MCP Tool Input/Output Models

These are the data shapes exposed via `@McpTool` endpoints. They reuse existing service DTOs where possible.

#### get_profile

**Input**: None
**Output**: Profile data (reuses `ProfileResponse` structure)

| Field | Type |
|-------|------|
| name | String |
| title | String |
| headline | String |
| description | String |
| location | String |
| primaryEmail | String |
| socialMediaLinks | List\<SocialMediaLink\> |

#### search_blogs

**Input**:

| Field | Type | Constraints |
|-------|------|-------------|
| query | String | Required, 2–200 characters |

**Output**: List of blog summaries (reuses `BlogSummaryResponse` fields)

| Field | Type |
|-------|------|
| id | String |
| title | String |
| summary | String |
| tags | List\<String\> |
| publishedDate | String |

#### get_jobs

**Input**: None
**Output**: List of jobs (reuses `JobSummaryDto` fields)

| Field | Type |
|-------|------|
| id | String |
| company | String |
| title | String |
| startDate | String |
| endDate | String (nullable) |
| summary | String |

#### get_skills

**Input**: None
**Output**: List of skill groups (reuses `SkillGroupSummaryDto` fields)

| Field | Type |
|-------|------|
| id | String |
| name | String |
| skills | List\<SkillSummary\> |

#### search_site

**Input**:

| Field | Type | Constraints |
|-------|------|-------------|
| query | String | Required, 2–200 characters |

**Output**: Grouped search results (reuses `GroupedSearchResponse` structure)

| Field | Type |
|-------|------|
| blogs | List\<SearchResult\> |
| jobs | List\<SearchResult\> |
| skills | List\<SearchResult\> |

## State Transitions

### Chat Session Lifecycle

```
[No Session]
    → CREATED (frontend generates UUID, sends first message)
    → ACTIVE (messages being exchanged)
    → EVICTED (30 min inactivity, cleaned up by scheduled task)
```

No explicit state field — lifecycle is implicit:
- **Created**: First message for a new `sessionId` creates memory in `InMemoryChatMemoryRepository`
- **Active**: Subsequent messages update `lastActivity` timestamp
- **Evicted**: `ChatSessionCleanupService` removes sessions inactive for 30+ minutes

## Validation Rules

| Entity | Field | Rule |
|--------|-------|------|
| ChatRequest | sessionId | Must be valid UUID format |
| ChatRequest | message | Not blank, max 500 characters |
| MCP search_blogs | query | Not blank, 2–200 characters |
| MCP search_site | query | Not blank, 2–200 characters |
